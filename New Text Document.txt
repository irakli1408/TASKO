<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Tasko SignalR Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@8.0.0/dist/browser/signalr.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #111;
            color: #eee;
            padding: 20px;
        }
        input, button {
            padding: 6px;
            margin: 4px 0;
        }
        #log {
            margin-top: 20px;
            padding: 10px;
            background: #222;
            height: 300px;
            overflow-y: auto;
            border-radius: 6px;
        }
        .msg {
            margin-bottom: 6px;
            border-bottom: 1px solid #333;
            padding-bottom: 4px;
        }
    </style>
</head>
<body>

<h2>Tasko SignalR Realtime Test</h2>

<label>JWT token:</label><br/>
<input id="token" style="width: 100%;" placeholder="Paste JWT here" /><br/>

<label>Task ID:</label><br/>
<input id="taskId" type="number" placeholder="Task ID" /><br/>

<button onclick="connect()">Connect & Join Task</button>

<hr/>

<label>Send message via HUB:</label><br/>
<input id="message" style="width: 80%;" placeholder="Message text" />
<button onclick="sendMessage()">Send</button>

<div id="log"></div>

<script>
    let connection = null;

    function log(text) {
        const el = document.createElement("div");
        el.className = "msg";
        el.innerText = text;
        document.getElementById("log").appendChild(el);
    }

    async function connect() {
        const token = document.getElementById("eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1laWRlbnRpZmllciI6IjIiLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1lIjoiaXJuaWtvbGVpc2h2aWxpQGdtYWlsLmNvbSIsInN1YiI6IjIiLCJlbWFpbCI6Imlybmlrb2xlaXNodmlsaUBnbWFpbC5jb20iLCJuYmYiOjE3NjY3NzM2MjcsImV4cCI6MTc2Njc3NDUyNywiaXNzIjoiVGFza28iLCJhdWQiOiJUYXNrb0NsaWVudCJ9.mewfgR0itLEGd19wvgLO4xzFGYPpHY91hd2O5kAWE7I").value;
        const taskId = document.getElementById("3").value;

        if (!token || !taskId) {
            alert("Token and TaskId required");
            return;
        }

        connection = new signalR.HubConnectionBuilder()
            .withUrl("http://localhost:5077/hubs/tasks", {
                accessTokenFactory: () => token
            })
            .withAutomaticReconnect()
            .build();

        connection.on("MessageReceived", message => {
            log("üì© MessageReceived: " + JSON.stringify(message));
        });

        connection.on("TypingStarted", data => {
            log("‚úç TypingStarted: " + JSON.stringify(data));
        });

        connection.on("TypingStopped", data => {
            log("‚úç TypingStopped: " + JSON.stringify(data));
        });

        try {
            await connection.start();
            log("‚úÖ Connected to hub");

            await connection.invoke("JoinTask", Number(taskId));
            log("üë• Joined task " + taskId);
        } catch (err) {
            log("‚ùå Error: " + err);
        }
    }

    async function sendMessage() {
        if (!connection) {
            alert("Not connected");
            return;
        }

        const taskId = Number(document.getElementById("taskId").value);
        const text = document.getElementById("message").value;

        await connection.invoke("SendMessage", taskId, text);
        log("‚û° Sent via HUB: " + text);
    }
</script>

</body>
</html>

